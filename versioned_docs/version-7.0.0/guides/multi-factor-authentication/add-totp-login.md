
# Add MFA with TOTP

The Time-based One-Time Password (TOTP) is a temporary passcode, generated by an algorithm that can be used only once. The algorithm that generates each password uses the current time of the day, which ensures that each password is unique.
TOTP is considered more secure because the passcode is valid only for a short window of time. The TOTP generated is valid for **30** seconds.

To use TOTP as a multi-factor authentication(MFA) option, application users need to have an authenticator app that can scan the QR code and generate a one-time password. Some authenticator apps are:

- [Google Authenticator](https://play.google.com/store/apps/details?id=com.google.android.apps.authenticator2)
- [Authy](https://play.google.com/store/apps/details?id=com.authy.authy)

!!! note
    TOTP authenticators use the [TOTP specification](https://datatracker.ietf.org/doc/html/rfc6238) to calculate access tokens based on the current time and the secret key shared between the user and the identity provider.

## Prerequisites
- To get started, you need to [create an application]({{base_path}}/guides/applications/). You can register your own application or use one of the [sample applications]({{base_path}}/get-started/try-samples/) provided.

- Download and install one of the authenticator apps mentioned above.

!!! note
    - You can use TOTP for multi-factor authentication only if a previous authentication step is configured with **username and password** or another factor that can validate user credentials.
    - TOTP cannot be used as the first step of your login flow.
    - Federated users (users who are authenticated using external IdPs) can log in with TOTP MFA option.

## Enable TOTP for an app

Follow the steps given below to enable **TOTP** as the second factor in the login flow of your application.

1. On the WSO2 Identity Server Console, go to **Applications**.

2. Select the application for which TOTP needs to be added.

3. Go to the **Login Flow** tab of the application and add the TOTP authenticator from your preferred editor:

    ---
    === "Classic Editor"
        - If you don't have a customized login flow, you can click **Add TOTP as a second factor**.

            <!-- ![Configuring TOTP authenticator in WSO2 Identity Server](/img/guides/mfa/totp/add-totp-authenticator.png){: width="600" style="display: block; margin: 0; border: 0.3px solid lightgrey;"} -->

            This opens the customized login flow with TOTP as a second-factor authenticator:

        - If you have an already customized login flow, you can add a second step and add TOTP as the authenticator.
            
            <!-- ![Customize the login flow](/assets/img/guides/mfa/totp/view-totp-authenticator.png){: width="600" style="display: block; margin: 0; border: 0.3px solid lightgrey;"} -->

    === "Visual Editor"
        To add TOTP as a second-factor authenticator using the Visual Editor:

        1. Switch to the **Visual Editor** tab and go to **Predefined Flows** > **Basic Flows** > **Add Multi-factor login**.

        2. Select `Username + Password -> TOTP`.

        3. Click **Confirm** to add TOTP as a second factor to the sign-in flow.

            <!-- ![Configuring TOTP authenticator in Asgardeo using the visual editor](/assets/img/guides/mfa/totp/add-totp-authenticator-using-visual-editor.png){: width="600" style="display: block; margin: 0; border: 0.3px solid lightgrey;"} -->

    ---

    !!! note "Enable backup codes"
        Once the TOTP authenticator is added, select **Enable backup codes**. This allows users to use their backup codes to log in to the application when they cannot obtain the required MFA codes.

        === "Using the classic editor"
            <!-- ![Enable backup codes for totp authenticator](/assets/img/guides/mfa/totp/enable-backup-codes.png){: width="500" style="border: 0.3px solid lightgrey;"} -->
        
        === "Using the visual editor"
            <!-- ![Enable backup codes for totp authenticator using the visual editor](/assets/img/guides/mfa/totp/enable-backup-codes-with-visual-editor.png){: width="500" style="border: 0.3px solid lightgrey;"} -->

        Learn more about [configuring backup codes for business users](/guides/user-self-service/manage-backup-codes/).

4. Click **Update** to save your changes.

## Disable enrolling in TOTP during first login

TOTP enrollment during the first login is enabled by default for all applications.

Administrators of an organization can configure their business applications to disable TOTP enrollment during the login flow of the users.

To disable TOTP enrollment during login:

1. On the WSO2 Identity Server Console, [enable TOTP](#enable-totp-for-an-app)  for a selected application.
2. Turn on **Conditional Authentication** by switching the toggle.
3. Add the following authentication script.

    !!! note
        The `authenticatorParams` method has been added to `executestep(2)`, assuming that TOTP is configured in step 2 of the authentication process. If you have configured TOTP in a different step, add the `authenticatorParams` method to the relevant step.

    ``` js
    var enrolUserInAuthenticationFlow = "false";

    var onLoginRequest = function (context) {
      executeStep(1);
      executeStep(2, {
          authenticatorParams: {
            common: {
                'enrolUserInAuthenticationFlow': enrolUserInAuthenticationFlow
            }
          }
      }, {
          onSuccess: function (context) {
            Log.info("Successfully managed login flow");
          }
      });
    };
    ```

    !!! note "Enable enrolling in TOTP at first login"
        To enable enrolling in TOTP the first time a user logs in, use any of the following approaches:
          
          - Update the value of `enrolUserInAuthenticationFlow` parameter to `true`.
            ```js 
            var enrolUserInAuthenticationFlow = "true";
            ```
          - Turn off **Conditional Authentication** by switching the toggle.

4. Click **Update** to save your changes.

## Try it out

Application users can enroll for TOTP authentication when they login to the business application for the first time. Given below are the steps that a user will follow:

1. Download an authenticator app to a mobile device.
2. Try to log in to the application by providing credentials. The user is prompted with a QR code.
3. Scan the QR code using the authenticator app, select the checkbox, and click **Continue**.

    !!! note
        - This step is prompted only when the user attempts to log in for the first time.
        - This step will not be prompted if you have [disabled enrolling in TOTP during first login](#disable-enrolling-in-totp-during-first-login).

    <!-- ![QR code for TOTP authenticator in WSO2 Identity Server]({{base_path}}/assets/img/guides/mfa/totp/scan-qr-code-totp.png){: width="300" style="border: 0.3px solid lightgrey;"} -->

4. Check the authenticator app and see that the TOTP is generated.

5. Enter the TOTP:
  
    <!-- ![User enters OTP token in WSO2 Identity Server]({{base_path}}/assets/img/guides/mfa/totp/enter-otp-token.png){: width="300" style="border: 0.3px solid lightgrey;"} -->

6. Click **Continue** to continue login.

!!! note
    If the QR code is deleted from the authenticator app, there is no way to recover it from the application. In such a scenario, the user should re-enroll for TOTP through the <b>Multi Factor Authentication</b> option in the My Account portal.

    Learn more about [enrolling TOTP from My Account]({{base_path}}/guides/user-self-service/enable-totp/).